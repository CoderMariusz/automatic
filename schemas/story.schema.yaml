# Story Schema
# Validates story YAML files generated in Stage 2 (Story Builder)
# Used by Flow 3 for scaffold generation

$schema: http://json-schema.org/draft-07/schema#
type: object
required:
  - story_id
  - epic
  - type
  - priority
  - complexity
  - status
  - title
  - description
  - acceptance_criteria

properties:
  story_id:
    type: string
    pattern: '^epic-\d{2}[a-z]?\.story-\d{2}$'
    description: Unique story identifier (e.g., "epic-01.story-01")

  epic:
    type: string
    pattern: '^epic-\d{2}[a-z]?$'
    description: Parent epic identifier

  type:
    type: string
    enum: [frontend, backend, fullstack]
    description: Story type based on implementation scope

  priority:
    type: string
    pattern: '^P[0-3]$'
    description: Priority (P0=highest, P3=lowest)

  complexity:
    type: string
    enum: [S, M, L]
    description: Story complexity (S=small, M=medium, L=large)

  status:
    type: string
    enum: [pending, in_progress, done, blocked]
    description: Current story status

  title:
    type: string
    minLength: 5
    maxLength: 80
    description: Short story title

  description:
    type: string
    minLength: 50
    maxLength: 2000
    description: Detailed story description

  acceptance_criteria:
    type: array
    minItems: 1
    maxItems: 4
    description: Story acceptance criteria (1-4 items based on complexity)
    items:
      $ref: '#/definitions/acceptance_criterion'

  technical_notes:
    type: array
    description: Technical implementation guidance
    items:
      type: string
      minLength: 10
      maxLength: 500

  ux_notes:
    type: array
    description: UI/UX implementation details
    items:
      type: string
      minLength: 10
      maxLength: 500

  dependencies:
    type: array
    description: Stories this story depends on
    items:
      type: string
      pattern: '^epic-\d{2}[a-z]?\.story-\d{2}$'

  estimated_effort:
    type: string
    pattern: '^\d+[hd]$'
    description: Estimated effort (e.g., "4h", "1d", "2d")

definitions:
  acceptance_criterion:
    type: object
    required:
      - id
      - title
      - given
      - when
      - then
    properties:
      id:
        type: string
        pattern: '^AC-\d{2}$'
        description: Unique AC identifier within story

      title:
        type: string
        minLength: 5
        maxLength: 100
        description: Descriptive AC title

      given:
        type: string
        minLength: 10
        maxLength: 500
        description: Precondition (user state, system state)

      when:
        type: string
        minLength: 10
        maxLength: 500
        description: User action or system trigger

      then:
        oneOf:
          - type: string
            minLength: 10
            maxLength: 500
          - type: array
            minItems: 1
            items:
              type: string
              minLength: 5
              maxLength: 300
        description: Expected outcome (string or array of outcomes)

      implementation:
        $ref: '#/definitions/implementation_details'
        description: Implementation details for Flow 3 scaffold (REQUIRED)

  implementation_details:
    type: object
    required:
      - component
      - test_file
    properties:
      component:
        type: string
        minLength: 5
        maxLength: 200
        description: File path for the component/module (e.g., "src/components/TaskList.tsx")

      hooks:
        type: array
        description: React hooks or functions used
        items:
          type: string
          minLength: 2
          maxLength: 50

      api_endpoint:
        type: string
        pattern: '^(GET|POST|PUT|PATCH|DELETE)\s+/.*$'
        description: API endpoint (e.g., "POST /api/tasks")

      test_file:
        type: string
        minLength: 5
        maxLength: 200
        description: Test file path (e.g., "tests/TaskList.test.tsx")

      dependencies:
        type: array
        description: npm packages to install
        items:
          type: string
          minLength: 1
          maxLength: 100

      database_schema:
        type: string
        maxLength: 500
        description: Database schema changes (e.g., "tasks(id, title, completed)")

      function_signature:
        type: string
        maxLength: 300
        description: Function signature (e.g., "createTask(title: string): Promise<Task>")

# Validation rules for complexity vs AC count
complexity_guidelines:
  S:
    ac_count: [1, 2]
    effort: "4h"
    description: "Single component, no API calls"
  M:
    ac_count: [2, 3]
    effort: "1d"
    description: "Component + API or state management"
  L:
    ac_count: [3, 4]
    effort: "2d"
    description: "Multiple components, complex state"

# Business rules (enforced by validator, not JSON Schema)
validation_rules:
  - "story_id must be unique across all stories"
  - "epic must reference an existing epic from Stage 1"
  - "AC count should match complexity guidelines"
  - "dependencies must reference valid story_ids"
  - "First story in epic typically has no dependencies"
  - "implementation.component path should follow project structure"
  - "implementation.test_file should be in tests/ directory"
