story_id: "10.prd-runner-core"
epic: "prd-flow"
type: "backend"
priority: "P0"
complexity: "XL"
status: "pending"

description: |
  Implementacja głównego orkiestratora dla PRD Flow (prd-runner.ts).

  Runner odpowiada za:
  - Inicjalizację projektu PRD
  - Wykonywanie kroków z plan-prd.yaml
  - Obsługę interaktywnych agentów (conversation loop)
  - Zarządzanie checkpointami (resume capability)
  - Warunkowe wykonywanie kroków (conditional steps)
  - Równoległe wykonywanie research agentów
  - Ekstrakcję i zapis outputów (YAML/Markdown)

acceptance_criteria:
  - id: AC-1
    title: "Project initialization"
    given: "User runs 'npm run prd'"
    when: "prd-runner.ts is executed"
    then:
      - "Creates prd/projects/current/ directory structure"
      - "Creates _meta.yaml with project metadata"
      - "Creates subdirectories: reports/, conversation/"
      - "Loads plan-prd.yaml configuration"

  - id: AC-2
    title: "Interactive step execution"
    given: "Step has type: interactive"
    when: "Step is executed"
    then:
      - "Loads instruction file from step.file"
      - "Starts conversation loop with LLM"
      - "Displays LLM responses to user"
      - "Prompts user for input via readline"
      - "Appends user responses to conversation history"
      - "Continues until ===NEXT_STEP_READY=== marker found"
      - "Saves conversation to conversation/{stepId}.log"
      - "Extracts and saves output files"

  - id: AC-3
    title: "LLM-only step execution"
    given: "Step has type: llm"
    when: "Step is executed"
    then:
      - "Loads instruction file"
      - "Injects input files into instruction"
      - "Executes single provider.execute() call"
      - "Extracts output (YAML/Markdown)"
      - "Saves to specified output paths"

  - id: AC-4
    title: "Script step execution"
    given: "Step has type: script"
    when: "Step is executed"
    then:
      - "Sets environment variables: PROJECT_DIR, PROJECT_ID"
      - "Executes script using: npx tsx {step.script}"
      - "Inherits stdio for real-time output"
      - "Captures exit code"
      - "Fails if exit code !== 0"

  - id: AC-5
    title: "Checkpoint management"
    given: "Interactive step completes successfully"
    when: "Step finishes"
    then:
      - "Creates/updates _checkpoint.yaml"
      - "Adds stepId to completed_steps array"
      - "Updates last_updated timestamp"
      - "Sets status: in_progress"

  - id: AC-6
    title: "Resume from checkpoint"
    given: "_checkpoint.yaml exists and --resume flag passed"
    when: "prd-runner.ts starts"
    then:
      - "Loads checkpoint data"
      - "Skips steps in completed_steps array"
      - "Continues from next uncompleted step"
      - "Displays: 'Resuming from step: {stepId}'"

  - id: AC-7
    title: "Conditional step execution"
    given: "Step has conditional field (e.g., 'research_config.tech.enabled')"
    when: "Step is about to execute"
    then:
      - "Loads research-config.yaml"
      - "Evaluates YAML path (split by '.')"
      - "If value === true, executes step"
      - "If value === false, skips step with log message"

  - id: AC-8
    title: "Parallel research execution"
    given: "Steps have parallel_group: 'PRD-R'"
    when: "Group is ready to execute"
    then:
      - "Filters steps by conditional evaluation"
      - "Executes enabled steps in parallel"
      - "Uses Promise.all() or DAG scheduler"
      - "Fails fast if any step fails"
      - "Waits for all to complete before continuing"

  - id: AC-9
    title: "Output extraction - YAML"
    given: "Output file ends with .yaml"
    when: "Extracting output from LLM response"
    then:
      - "Tries to extract from ```yaml code block"
      - "Falls back to raw YAML detection (lines starting with key:)"
      - "Stops at ===NEXT_STEP_READY=== marker"
      - "Saves extracted content to file path"

  - id: AC-10
    title: "Output extraction - Markdown"
    given: "Output file ends with .md"
    when: "Extracting output from LLM response"
    then:
      - "Extracts everything before ===NEXT_STEP_READY==="
      - "Preserves markdown formatting"
      - "Saves to file path"

technical_notes:
  - "Reuse ProviderFactory from providers/provider-factory.ts"
  - "Reuse logging helpers from runner.ts (logOk, logFail, logInfo)"
  - "Use Node.js readline module for interactive prompts"
  - "Use yaml.parse() and yaml.stringify() from 'yaml' package"
  - "Follow existing runner.ts patterns for consistency"
  - "Handle Ctrl+C gracefully - save checkpoint before exit"

files_to_create:
  - path: "prd-runner.ts"
    description: "Main PRD Flow orchestrator (~600 lines)"

files_to_modify: []

dependencies:
  - "flow-menu.ts (already created)"
  - "plan-prd.yaml (already created)"
  - "providers/provider-factory.ts (existing)"
  - "providers/claude-provider.ts (existing)"
  - "providers/glm-provider.ts (existing)"

testing:
  - "Create dummy instruction file with simple Q&A"
  - "Test interactive loop with manual user input"
  - "Test checkpoint save/resume functionality"
  - "Test conditional step skipping"
  - "Verify output extraction for both YAML and Markdown"
