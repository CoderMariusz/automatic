story_id: "16.prd-validator"
epic: "prd-flow"
type: "backend"
priority: "P0"
complexity: "M"
status: "pending"

description: |
  Implementacja skryptu walidacji PRD (automation/prd-validator.ts).

  Skrypt (0 LLM tokens) sprawdza kompletność i spójność PRD:
  - Czy wszystkie cele z discovery są w PRD
  - Czy wszystkie MVP features z discovery są w PRD
  - Czy moduły z brainstorm są w PRD
  - Czy user flows z brainstorm są w PRD
  - Czy decyzje techniczne z brainstorm są w PRD
  - Czy success metrics z discovery są w PRD
  - Czy wszystkie wymagane sekcje PRD istnieją

  Generuje validation-report.yaml z checklistą i score.

acceptance_criteria:
  - id: AC-1
    title: "Check 1: Goals coverage (FAIL if missing)"
    given: "Script runs"
    when: "Checking goals"
    then:
      - "For each discovery.goals.primary[].goal:"
      - "  - Takes first 20 characters"
      - "  - Searches PRD (case-insensitive substring match)"
      - "  - Status: PASS if found, FAIL if not found"
      - "  - Details: 'Found in PRD' or 'NOT FOUND in PRD - goal may be missing'"

  - id: AC-2
    title: "Check 2: MVP Features coverage (FAIL if missing)"
    given: "Script runs"
    when: "Checking MVP features"
    then:
      - "For each discovery.scope.mvp_features[]:"
      - "  - Takes first 15 characters"
      - "  - Searches PRD (case-insensitive)"
      - "  - Status: PASS if found, FAIL if not"

  - id: AC-3
    title: "Check 3: Modules coverage (WARN if missing)"
    given: "Script runs"
    when: "Checking modules"
    then:
      - "For each brainstorm.modules[].name:"
      - "  - Searches for 'Module: {name}' or case-insensitive match"
      - "  - Status: PASS if found, WARN if not"
      - "  - Details: 'Found in PRD' or 'Module name not explicitly found'"

  - id: AC-4
    title: "Check 4: User Flows coverage (WARN if missing)"
    given: "Script runs"
    when: "Checking flows"
    then:
      - "For each brainstorm.user_flows[].name:"
      - "  - Searches for 'Flow: {name}' or match"
      - "  - Status: PASS if found, WARN if not"

  - id: AC-5
    title: "Check 5: Technical Decisions (WARN if missing)"
    given: "Script runs"
    when: "Checking decisions"
    then:
      - "For each brainstorm.technical_decisions[].decision:"
      - "  - Takes first 15 chars, searches in PRD"
      - "  - Status: PASS if found, WARN if not"

  - id: AC-6
    title: "Check 6: Success Metrics (FAIL if missing)"
    given: "Script runs"
    when: "Checking metrics"
    then:
      - "For each discovery.success_metrics[].metric:"
      - "  - Takes first 10 chars, searches in PRD"
      - "  - Status: PASS if found, FAIL if not"

  - id: AC-7
    title: "Check 7: Required Sections (FAIL if missing)"
    given: "Script runs"
    when: "Checking structure"
    then:
      - "Required sections:"
      - "  - 'Executive Summary'"
      - "  - 'Problem Statement'"
      - "  - 'Goals'"
      - "  - 'Target Users'"
      - "  - 'Features'"
      - "  - 'Technical Architecture'"
      - "  - 'Risks'"
      - "For each, searches for '## {section}' (case-insensitive)"
      - "Status: PASS if all found, FAIL for any missing"

  - id: AC-8
    title: "Report generation - validation-report.yaml"
    given: "All checks complete"
    when: "Script outputs report"
    then:
      - "Outputs YAML with:"
      - "  generated_at: {ISO timestamp}"
      - "  summary:"
      - "    total_checks: {count}"
      - "    passed: {count}"
      - "    failed: {count}"
      - "    warnings: {count}"
      - "    score: {(passed/total)*100}"
      - "  status: 'VALID' if failed===0, else 'NEEDS_REVIEW'"
      - "  results_by_category: {grouped results}"
      - "  checklist[] - category, item, status, checkbox ([x] or [ ]), details"

  - id: AC-9
    title: "Environment variables"
    given: "Script is executed by prd-runner"
    when: "Script starts"
    then:
      - "Reads process.env.PROJECT_DIR"
      - "Reads process.env.PROJECT_ID"
      - "Loads files from PROJECT_DIR:"
      - "  - discovery.yaml"
      - "  - brainstorm.yaml"
      - "  - prd.md"

  - id: AC-10
    title: "Exit code"
    given: "Script finishes"
    when: "Script exits"
    then:
      - "Always exits with code 0 (even if validation fails)"
      - "Validation failures are reported in validation-report.yaml"
      - "Script errors (file not found, parse errors) exit with code 1"

technical_notes:
  - "TypeScript file ~300 lines"
  - "Uses fs.readFileSync to load files"
  - "Uses yaml.parse() from 'yaml' package"
  - "Simple string matching (case-insensitive, substring)"
  - "No LLM calls - pure script"
  - "Reference plan section 4.10"
  - "Helper function: groupByCategory(results)"

files_to_create:
  - path: "automation/prd-validator.ts"
    description: "PRD validation script (~300 lines)"

files_to_modify: []

example_output: |
  ```yaml
  # validation-report.yaml
  generated_at: "2026-01-21T14:00:00Z"
  summary:
    total_checks: 42
    passed: 38
    failed: 2
    warnings: 2
    score: 90

  status: "NEEDS_REVIEW"

  results_by_category:
    Goals:
      - item: "Zmniejszyć czas administracji o 50%"
        status: PASS
        details: "Found in PRD"
      - item: "Zwiększyć retencję o 20%"
        status: FAIL
        details: "NOT FOUND in PRD - goal may be missing"

  checklist:
    - category: "Goals"
      item: "Zmniejszyć czas administracji"
      status: PASS
      checkbox: "[x]"
      details: "Found in PRD"
    - category: "Goals"
      item: "Zwiększyć retencję"
      status: FAIL
      checkbox: "[ ]"
      details: "NOT FOUND in PRD"
  ```
